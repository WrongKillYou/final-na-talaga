{% extends 'base.html' %}

{% block title %}Record Attendance{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-11">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-clipboard-check text-primary"></i> Record Attendance</h2>
            <a href="{% url 'monitoring:attendance_list' %}" class="btn btn-outline-primary">
                <i class="bi bi-list-ul"></i> View Attendance List
            </a>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <!-- Date and Class Selection -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form method="get">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Date</label>
                            <input type="date" name="date" class="form-control" value="{{ selected_date|date:'Y-m-d' }}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Select Class</label>
                            <select name="class_id" class="form-select" required>
                                <option value="">-- Choose Class --</option>
                                {% for class in classes %}
                                    <option value="{{ class.id }}" {% if selected_class and class.id == selected_class.id %}selected{% endif %}>
                                        {{ class.subject }} - {{ class.grade_level }} {{ class.section }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search"></i> Load</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        {% if selected_class %}
            <div class="alert alert-info mb-4">
                <strong>Class:</strong> {{ selected_class.subject }} - {{ selected_class.grade_level }} {{ selected_class.section }}<br>
                <strong>Date:</strong> {{ selected_date|date:'F d, Y' }}<br>
                <strong>Total Students:</strong> {{ children|length }}
            </div>

            <!-- Attendance Form -->
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="date" value="{{ selected_date|date:'Y-m-d' }}">
                <input type="hidden" name="class_id" value="{{ selected_class.id }}">

                <div class="card shadow-sm">
                    <div class="card-header bg-white"><h5>Students</h5></div>
                    <div class="card-body">
                        {% if children %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Student Name</th>
                                            <th>Status</th>
                                            <th>Time In</th>
                                            <th>Time Out</th>
                                            <th>Remarks</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for child in children %}
                                            <tr>
                                                <td>
                                                    <strong>{{ child.child.get_full_name }}</strong><br>
                                                    <small class="text-muted">LRN: {{ child.child.lrn }}</small>
                                                </td>
                                                <td>
                                                    <select name="status_{{ child.child.id }}" class="form-select form-select-sm">
                                                        {% for val, label in status_choices %}
                                                            <option value="{{ val }}" {% if child.status == val %}selected{% endif %}>{{ label }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </td>
                                                <td><input type="time" class="form-control form-control-sm" name="time_in_{{ child.child.id }}" value="{{ child.time_in|default:'' }}"></td>
                                                <td><input type="time" class="form-control form-control-sm" name="time_out_{{ child.child.id }}" value="{{ child.time_out|default:'' }}"></td>
                                                <td><input type="text" class="form-control form-control-sm" name="remarks_{{ child.child.id }}" value="{{ child.remarks }}"></td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted text-center">No students enrolled in this class.</p>
                        {% endif %}
                    </div>
                    {% if children %}
                        <div class="card-footer text-end">
                            <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Save Attendance</button>
                        </div>
                    {% endif %}
                </div>
            </form>
        {% endif %}
    </div>
</div>
{% endblock %}
